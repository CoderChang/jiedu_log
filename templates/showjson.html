<!DOCTYPE html>
<html>
  <head>
    <title>sds-jiedu</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <script src="static/script/dropzone.js"></script>
    <script src="static/script/d3.v3.min.js"></script>
    <script src="static/script/jquery-latest.min.js"></script>
    <style type="text/css">

body {
  overflow: hidden;
  margin: 0;
  font-size: 14px;
  font-family: "Helvetica Neue", Helvetica;
}

#footer {
  position: absolute;
  z-index: 1;
  display: block;
  font-size: 36px;
  font-weight: 300;
  text-shadow: 0 1px 0 #fff;
  text-align: right;
}

rect {
  fill: none;
  pointer-events: all;
}

.node circle {
  cursor: pointer;
  fill: #fff;
  stroke-width: 1.5px;
}

.node text {
  font-size: 11px;
}

path.link {
  fill: none;
  stroke: gray;
  stroke-width: 1.5px;
}

    </style>
  </head>
  <body>
    <div  id="body">
        <div id="footer">
            <button type="button" onclick="expandWholeTree();">展开</button>
            <button type="button" onclick="shrinkWholeTree();">收回</button>
        </div>
    </div>
    <script type="text/javascript">

var w_max = window.innerWidth,
    h_max = window.innerHeight;

var m = [20, 120, 20, 120],
    w = w_max - m[1] - m[3],
    h = h_max - m[0] - m[2],
    i = 0;

// set footer poisition
$("#footer").css("right", 5);


var root;

function comparatorCount(a, b) {
    if (a.count > b.count) {
        return 1;
    }
    else if (a.count < b.count){
        return -1;
    }
    else {
        return a.name > b.name ? 1 : -1;
    }
}
function comparatorSuccess(a, b) {
    if (a.success > b.success) {
        return 1;
    }
    else if (a.success < b.success){
        return -1;
    }
    else {
        return a.name > b.name ? 1 : -1;
    }
}

function zoom() {
    update(root);
}

var zoom_x = d3.scale.linear()
    .domain([0, w])
    .range([0, w]);

var zoom_y = d3.scale.linear()
    .domain([0, h])
    .range([h, 0]);

var zoom = d3.behavior.zoom()
    .x(zoom_x)
    .y(zoom_y)
    .scaleExtent([0.5,5])
    .on("zoom", zoom);

var log_size = d3.scale.log()
    .range([4,20]);
var linear_size = d3.scale.linear()
    .range([4,20])

var tree = d3.layout.tree()
    .size([h, w])
    .sort(comparatorCount);

var diagonal = d3.svg.diagonal()
    .projection(function(d) { return [d.y, d.x]; });

var vis = d3.select("#body").append("svg:svg")
    .attr("width", w_max)
    .attr("height", h_max)
    .append("svg:g")
    .attr("transform", "translate(" + m[3] + "," + m[0] + ")")
    .call(zoom);

vis.append("rect")
    .attr("id", "overlay_rect")
    .attr("x", -$("#overlay_rect").offset().left)
    .attr("y", -$("#overlay_rect").offset().top)
    .attr("class", "overlay")
    .attr("width", w_max)
    .attr("height", h_max);

function toggleAll(d) {
    if (d.children) {
        d.children.forEach(toggleAll);
        toggle(d);
    }
}

d3.json("uploads/tree.json", function(json) {
    root = json;
    root.x0 = h / 2;
    root.y0 = 0;

    log_size.domain([1, root.count]);

    // Initialize the display to show a few nodes.
    root.children.forEach(toggleAll);
    //toggle(root.children[1]);
    //toggle(root.children[1].children[1]);

    update(root);
});


function update(source) {
    var duration = d3.event && d3.event.altKey ? 5000 : 500;

    // Compute the new tree layout.
    var nodes = tree.nodes(root);

    // Normalize for fixed-depth.
    nodes.forEach(function(d) {
        d.x = zoom_y(d.x);
        d.y = zoom_x(d.depth * 180);
    });

    // Update the nodes…
    var node = vis.selectAll("g.node")
        .data(nodes, function(d) { return d.id || (d.id = ++i); });

    // Enter any new nodes at the parent's previous position.
    var nodeEnter = node.enter().append("svg:g")
        .attr("class", "node")
        .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
        .on("click", function(d) { toggle(d); update(d); })

    nodeEnter.append("svg:circle")
        .attr("r", function(d) { return log_size(d.count>1 ? d.count : 1)})
        .style("fill", function(d) { return d._children && d._children.length ? "lightsteelblue" : "#fff"; })
        .style("stroke", function(d) { return d.depth % 2 ? "royalblue" : "yellowgreen"; })
        .on("mouseover", function(d) {
            showToolTip(d, true);
        })
        .on("mouseout", function(d) {
            showToolTip(d, false);
        })

    nodeEnter.append("svg:text")
        .attr("x", function(d) { return d.children || d._children ? -10 : 10; })
        .attr("dy", ".35em")
        .attr("text-anchor", function(d) { return d.children || d._children ? "end" : "start"; })
        .text(function(d) { return d.name; })
        .style("fill-opacity", 1e-6);

    // Transition nodes to their new position.
    var nodeUpdate = node.transition()
        .duration(duration)
        .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; });

    nodeUpdate.select("circle")
        .attr("r", function(d) { return log_size(d.count>1 ? d.count : 1)})
        .style("fill", function(d) { return d._children && d._children.length ? "lightsteelblue" : "#fff"; })
        .style("stroke", function(d) { return d.depth % 2 ? "royalblue" : "yellowgreen"; })

    nodeUpdate.select("text")
        .style("fill-opacity", 1);

    // Transition exiting nodes to the parent's new position.
    var nodeExit = node.exit().transition()
        .duration(duration)
        .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
        .remove();

    nodeExit.select("circle")
        .attr("r", function(d) { return log_size(d.count>1 ? d.count : 1)})

    nodeExit.select("text")
        .style("fill-opacity", 1e-6);

    // Update the links…
    var link = vis.selectAll("path.link")
        .data(tree.links(nodes), function(d) { return d.target.id; });

    // Enter any new links at the parent's previous position.
    link.enter().insert("svg:path", "g")
        .attr("class", "link")
        .attr("d", function(d) {
            var o = {x: source.x0, y: source.y0};
            return diagonal({source: o, target: o});
        })
        .transition()
        .duration(duration)
        .attr("d", diagonal)

    // Transition links to their new position.
    link.transition()
        .duration(duration)
        .attr("d", diagonal);

    // Transition exiting nodes to the parent's new position.
    link.exit().transition()
        .duration(duration)
        .attr("d", function(d) {
            var o = {x: source.x, y: source.y};
            return diagonal({source: o, target: o});
        })
        .remove();

    // Stash the old positions for transition.
    nodes.forEach(function(d) {
        d.x0 = d.x;
        d.y0 = d.y;
    });
}

// Toggle children.
function toggle(d) {
    if (d) {
        if (d.children) {
            d._children = d.children;
            d.children = null;
        } else {
            d.children = d._children;
            d._children = null;
        }
    }
}


// Expand whole tree
function expandWholeTree() {
    root.children.forEach(expandAll);
    update(root);
}
function expandAll(d) {
    if (d.children || d._children) {
        expand(d);
        d.children.forEach(expandAll);
    }
}
// Expand children.
function expand(d) {
    if (d && d._children) {
        d.children = d._children;
        d._children = null;
    }
}
// Shrink whole tree
function shrinkWholeTree() {
     root.children.forEach(shrinkAll);
     update(root);
}
function shrinkAll(d) {
    if (d.children || d._children) {
        shrink(d);
        d._children.forEach(shrinkAll);
    }
}
// shrink children.
function shrink(d) {
    if (d && d.children) {
        d._children = d.children;
        d.children = null;
    }
}


function showToolTip(d, pShow)
{
    var pMessage = "name: " + (d.name ? d.name : '-') + "<br>count :" + (d.count ? d.count : '-') + "<br>level :" + (d.level || d.level==0 ? d.level : '-') + "<br><span style=\"color:red;\">success: " + (d.success || d.success==0 ? (d.success*100).toFixed(2) + '%' : '-') + "</span>" + "<br><span>files: " + (d.files ? d.files.length : '-') + "</span>";
    if (typeof(tooltipDivID)=="undefined")
    {
        tooltipDivID =$('<div id="messageToolTipDiv" style="position:absolute;display:block;z-index:10000;border:2px solid black;background-color:rgba(0,0,0,0.8);margin:auto;padding:3px 5px 3px 5px;color:white;font-size:12px;font-family:arial;border-radius: 5px;vertical-align: middle;text-align: center;min-width:50px;overflow:auto;"></div>');
        $('body').append(tooltipDivID);
    }
    if (!pShow) { tooltipDivID.hide(); return; }
    tooltipDivID.html(pMessage);
    tooltipDivID.css({top: d3.event.pageY+20, left: d3.event.pageX+20});
    tooltipDivID.show();
}

    </script>
  </body>
</html>
